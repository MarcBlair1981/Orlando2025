<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orlando Family Trip Planner</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light gray background */
        }
        .container-main {
            min-height: 100vh;
        }
        .itinerary-grid {
            display: grid;
            grid-template-columns: 200px repeat(12, minmax(100px, 1fr)); /* Fixed Day column + 12 family members */
            overflow-x: auto;
            border-radius: 0.5rem;
        }
        .grid-header, .grid-cell {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .grid-header {
            background-color: #1e3a8a; /* Dark blue header */
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .grid-header-day {
            position: sticky;
            left: 0;
            z-index: 20;
            background-color: #1e3a8a; 
        }
        .grid-cell-day {
            position: sticky;
            left: 0;
            z-index: 5;
            background-color: #dbeafe; /* Light blue for day column */
            font-weight: 600;
        }
        .grid-input {
            width: 100%;
            border: none;
            background: transparent;
            min-height: 3rem;
            resize: none;
            padding: 0.25rem;
            box-sizing: border-box;
            outline: none;
        }
        .tab-button.active {
            border-color: #1e3a8a;
            color: #1e3a8a;
            background-color: #eff6ff;
        }
        .chat-message {
            border-radius: 0.75rem;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-sender {
            font-weight: 600;
            font-size: 0.75rem;
            opacity: 0.8;
            margin-bottom: 0.125rem;
        }
        .message-mine {
            background-color: #bfdbfe; /* Light blue */
            margin-left: auto;
        }
        .message-other {
            background-color: #e5e7eb; /* Light gray */
            margin-right: auto;
        }
        /* Style for mobile view of the grid */
        @media (max-width: 768px) {
            .itinerary-grid {
                grid-template-columns: 100px repeat(12, minmax(150px, 1fr)); /* Wider columns for mobile content */
            }
            .chat-container {
                max-height: 60vh;
            }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container-main mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-indigo-800 tracking-tight">
                üå¥ Orlando 2025: Family Trip Planner
            </h1>
            <p class="mt-2 text-xl text-gray-600">
                The ultimate collaborative itinerary & chat for the Blair & Rosenberg families.
            </p>
        </header>

        <!-- Authentication and Status Indicator -->
        <div class="mb-6 p-3 bg-white shadow-lg rounded-lg text-sm">
            <p id="auth-status" class="text-gray-700 font-medium">Initializing Firebase...</p>
            <p class="text-xs text-gray-500 mt-1">
                Your ID for collaboration: <span id="current-user-id" class="font-mono text-xs text-indigo-500 bg-indigo-50 p-1 rounded">loading</span>
            </p>
        </div>

        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-itinerary" class="tab-button active py-2 px-4 text-gray-600 border-b-2 border-transparent transition duration-150 ease-in-out font-medium hover:border-blue-500" onclick="showTab('itinerary')">
                Itinerary Spreadsheet
            </button>
            <button id="tab-chat" class="tab-button py-2 px-4 text-gray-600 border-b-2 border-transparent transition duration-150 ease-in-out font-medium hover:border-blue-500" onclick="showTab('chat')">
                Family Chat Room
            </button>
        </div>

        <!-- ITINERARY TAB CONTENT -->
        <div id="itinerary-content" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Day-by-Day Itinerary</h2>
            <div class="mb-4 text-sm text-gray-600">
                <p>Click on any cell to edit the plan for that specific day and activity. Changes save instantly!</p>
            </div>
            
            <!-- Itinerary Grid Container -->
            <div class="bg-white shadow-xl rounded-lg overflow-hidden">
                <div class="itinerary-grid" id="itinerary-grid">
                    <!-- Dynamic Grid Content will be inserted here -->
                </div>
            </div>
        </div>

        <!-- CHAT TAB CONTENT -->
        <div id="chat-content" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Real-Time Chat</h2>
            
            <div id="chat-container" class="chat-container bg-white shadow-xl rounded-lg p-4 mb-4 h-96 overflow-y-auto flex flex-col-reverse">
                <div id="chat-messages" class="flex flex-col">
                    <!-- Dynamic Chat Messages will be inserted here -->
                </div>
            </div>

            <!-- Chat Input Form -->
            <form id="chat-form" class="flex gap-2">
                <input type="text" id="chat-input" placeholder="Type your message..." required class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                    Send
                </button>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, query, orderBy, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES & INITIAL SETUP ---
        
        // 1. INTERNAL PREVIEW CONFIG (Available inside this editor)
        // We check if we are running inside the Canvas environment to avoid the "Missing Config" error while previewing.
        const internalConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const internalAppId = typeof __app_id !== 'undefined' ? __app_id : null;
        const internalAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 2. EXTERNAL DEPLOYMENT CONFIG (For GitHub Pages)
        // >>> ACTION REQUIRED FOR GITHUB <<<
        // Replace these values with your Firebase Project keys when deploying to GitHub.
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDoI1tIeSZw_ccBGPIGIfF2h30S3o9negU", // <-- REPLACE THIS VALUE
            authDomain: "orlando-2025-c9a88.firebaseapp.com", 
            projectId: "orlando-2025-c9a88",
            storageBucket: "orlando-2025-c9a88.firebasestorage.app",
            messagingSenderId: "576935089586",
            appId: "1:576935089586:web:b2822131481acf724f00ab"
        };

        // LOGIC: Prefer Internal Config (for immediate preview), fall back to Manual (for external site)
        let firebaseConfig;
        let appId;
        let isInternalEnv = false;

        if (internalConfig) {
            // We are in the preview environment
            firebaseConfig = internalConfig;
            appId = internalAppId || 'default-app-id';
            isInternalEnv = true;
        } else {
            // We are on GitHub Pages (or local file)
            firebaseConfig = MANUAL_FIREBASE_CONFIG;
            appId = "orlando-trip-app-prod"; 
            isInternalEnv = false;
        }

        let app;
        let db;
        let auth;
        let userId = 'loading';
        
        // The list of family members for the spreadsheet columns
        const FAMILY_MEMBERS = [
            { id: "Marc", name: "Marc Blair", age: 43 },
            { id: "Melissa", name: "Melissa Blair", age: 39 },
            { id: "Billie", name: "Billie Blair", age: 10 },
            { id: "Mimi", name: "Mimi Blair", age: 6 },
            { id: "Daniel", name: "Daniel Rosenberg", age: 39 },
            { id: "Jessica", name: "Jessica Blair", age: 37 },
            { id: "Joey", name: "Joey Rosenberg", age: 5 }, 
            { id: "Emma", name: "Emma Rosenberg", age: 7 }, 
            { id: "Riley", name: "Riley Rosenberg", age: 1 },
            { id: "John", name: "John Blair", age: 71 },
            { id: "Lindsay", name: "Lindsay Blair", age: 70 },
            { id: "Ricky", name: "Ricky Blair", age: 41 },
        ];

        // The rows/activities planned for the trip
        const ACTIVITY_ROWS = [
            { id: 'day1-am', name: 'Dec 22: Morning (Arrivals)' },
            { id: 'day1-pm', name: 'Dec 22: Afternoon/Evening' },
            { id: 'day2-am', name: 'Dec 23: Epcot Morning' },
            { id: 'day2-pm', name: 'Dec 23: Epcot Evening' },
            { id: 'day3-am', name: 'Dec 24: Animal Kingdom' },
            { id: 'day3-pm', name: 'Dec 24: Christmas Eve Dinner' },
            { id: 'day4-am', name: 'Dec 25: Christmas Morning' },
            { id: 'day4-pm', name: 'Dec 25: Holiday Dinner' },
        ];


        const ITINERARY_DOC_PATH = `artifacts/${appId}/public/data/orlando_planning/itinerary`;
        const CHAT_COLLECTION_PATH = `artifacts/${appId}/public/data/orlando_planning_chat`;

        // --- UI UTILITIES ---

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            document.getElementById(`${tabId}-content`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // --- FIRESTORE UTILITIES ---

        function getItineraryDocRef() {
            return doc(db, ITINERARY_DOC_PATH);
        }

        function getChatCollectionRef() {
            return collection(db, CHAT_COLLECTION_PATH);
        }

        // --- ITINERARY LOGIC (SPREADSHEET) ---

        /**
         * Renders the initial structure of the spreadsheet (headers and cells).
         */
        function renderItineraryStructure() {
            const grid = document.getElementById('itinerary-grid');
            grid.innerHTML = ''; // Clear existing content

            // 1. Render Header Row
            let headerHtml = `<div class="grid-header grid-header-day">Activity</div>`;
            FAMILY_MEMBERS.forEach(member => {
                headerHtml += `<div class="grid-header text-center">${member.name} (${member.age})</div>`;
            });
            grid.insertAdjacentHTML('beforeend', headerHtml);

            // 2. Render Activity Rows
            ACTIVITY_ROWS.forEach(row => {
                let rowHtml = `<div class="grid-cell grid-cell-day">${row.name}</div>`;
                FAMILY_MEMBERS.forEach(member => {
                    // Unique ID for each cell: activityId_memberId
                    const cellId = `${row.id}_${member.id}`;
                    rowHtml += `
                        <div class="grid-cell" id="cell-${cellId}">
                            <textarea 
                                class="grid-input" 
                                id="input-${cellId}"
                                data-activity-id="${row.id}" 
                                data-member-id="${member.id}"
                                oninput="updateItineraryCell(this.dataset.activityId, this.dataset.memberId, this.value)"
                            ></textarea>
                        </div>
                    `;
                });
                grid.insertAdjacentHTML('beforeend', rowHtml);
            });
        }

        /**
         * Fills the spreadsheet with data from Firestore.
         * @param {Object} data - The itinerary data object.
         */
        function populateItineraryData(data) {
            ACTIVITY_ROWS.forEach(row => {
                FAMILY_MEMBERS.forEach(member => {
                    const cellId = `${row.id}_${member.id}`;
                    const inputElement = document.getElementById(`input-${cellId}`);
                    
                    if (inputElement) {
                        // Data structure: { "day1-am": { "Marc": "Content" } }
                        const content = data[row.id] && data[row.id][member.id] !== undefined ? data[row.id][member.id] : '';
                        inputElement.value = content;
                    }
                });
            });
        }

        /**
         * Saves a single cell update to Firestore. Uses debouncing for efficiency.
         * @param {string} activityId - The ID of the activity row.
         * @param {string} memberId - The ID of the family member column.
         * @param {string} value - The new cell content.
         */
        const updateDebounceMap = new Map();
        function updateItineraryCell(activityId, memberId, value) {
            if (!db || userId === 'loading') return;

            // Clear previous timeout for this cell
            if (updateDebounceMap.has(`${activityId}_${memberId}`)) {
                clearTimeout(updateDebounceMap.get(`${activityId}_${memberId}`));
            }

            // Set new timeout
            const timeout = setTimeout(async () => {
                const docRef = getItineraryDocRef();
                
                // Firestore uses dot notation to update nested fields without overwriting
                const fieldPath = `${activityId}.${memberId}`;
                const updateObject = {
                    [fieldPath]: value,
                    lastUpdatedBy: userId,
                    timestamp: serverTimestamp()
                };

                try {
                    await setDoc(docRef, updateObject, { merge: true });
                    // Visual confirmation
                    const cellElement = document.getElementById(`cell-${activityId}_${memberId}`);
                    if (cellElement) {
                        cellElement.classList.add('bg-green-100');
                        setTimeout(() => cellElement.classList.remove('bg-green-100'), 500);
                    }

                } catch (e) {
                    console.error("Error updating document: ", e);
                    document.getElementById('auth-status').textContent = `Save Error: ${e.message}`;
                }
            }, 750); // 750ms debounce time

            updateDebounceMap.set(`${activityId}_${memberId}`, timeout);
        }

        /**
         * Initializes the itinerary document in Firestore if it doesn't exist.
         */
        async function initializeItinerary() {
            if (!db) return;

            const docRef = getItineraryDocRef();
            try {
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    // Create an initial, empty structure
                    const initialData = {
                        itinerary: "Orlando Trip Plan",
                        lastUpdatedBy: userId,
                        timestamp: serverTimestamp()
                    };
                    
                    // Initialize nested objects for each activity row
                    ACTIVITY_ROWS.forEach(row => {
                        initialData[row.id] = {};
                        FAMILY_MEMBERS.forEach(member => {
                             initialData[row.id][member.id] = '';
                        });
                    });

                    await setDoc(docRef, initialData, { merge: true });
                    console.log("Itinerary document created.");
                }
            } catch (e) {
                console.error("Error initializing itinerary:", e);
            }
        }

        // --- CHAT LOGIC ---

        /**
         * Handles sending a new chat message.
         */
        async function sendChatMessage(event) {
            event.preventDefault();
            if (!db || userId === 'loading') return;

            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();

            if (message) {
                try {
                    await addDoc(getChatCollectionRef(), {
                        text: message,
                        senderId: userId,
                        timestamp: serverTimestamp()
                    });
                    chatInput.value = ''; // Clear input field
                } catch (e) {
                    console.error("Error sending message: ", e);
                    document.getElementById('auth-status').textContent = `Chat Error: ${e.message}`;
                }
            }
        }

        /**
         * Renders all chat messages.
         * @param {Array<Object>} messages - Array of chat message objects.
         */
        function renderChatMessages(messages) {
            const chatMessagesDiv = document.getElementById('chat-messages');
            chatMessagesDiv.innerHTML = ''; // Clear existing

            messages.forEach(msg => {
                const isMine = msg.senderId === userId;
                const alignment = isMine ? 'justify-end' : 'justify-start';
                const colorClass = isMine ? 'message-mine' : 'message-other';
                
                const timestamp = msg.timestamp && msg.timestamp.toDate ? 
                    msg.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 
                    'Sending...';

                const messageHtml = `
                    <div class="flex ${alignment}">
                        <div class="chat-message ${colorClass} shadow-sm">
                            <div class="chat-sender text-gray-500">
                                ${isMine ? 'You' : msg.senderId.substring(0, 8)} (${timestamp})
                            </div>
                            <div class="text-gray-900">${msg.text}</div>
                        </div>
                    </div>
                `;
                chatMessagesDiv.insertAdjacentHTML('beforeend', messageHtml);
            });

            // Auto-scroll to the bottom (since we use flex-col-reverse, this means scrolling to the top of the container)
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight; 
            }
        }

        // --- REALTIME LISTENERS ---

        function setupRealtimeListeners() {
            if (!db) return;

            // 1. Itinerary Listener
            const docRef = getItineraryDocRef();
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    populateItineraryData(docSnap.data());
                } else {
                    console.log("Itinerary document does not exist, initializing...");
                }
            }, (error) => {
                console.error("Itinerary Snapshot Error: ", error);
            });

            // 2. Chat Listener
            const chatQuery = query(getChatCollectionRef(), orderBy("timestamp", "desc"));
            onSnapshot(chatQuery, (querySnapshot) => {
                const messages = [];
                querySnapshot.forEach(doc => {
                    messages.push(doc.data());
                });
                // Reverse the order to display newest message at the bottom
                renderChatMessages(messages.reverse()); 
            }, (error) => {
                console.error("Chat Snapshot Error: ", error);
            });
        }

        // --- AUTHENTICATION & INITIALIZATION ---

        function initializeFirebase() {
            // Logic to verify if we have a valid configuration
            // 1. Internal Environment
            if (isInternalEnv) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('current-user-id').textContent = userId;
                        document.getElementById('auth-status').textContent = `Authenticated (Internal) User: ${userId}`;
                        setupRealtimeListeners();
                        initializeItinerary();
                    } else {
                         // Try custom token sign in if available, else anonymous
                         if (internalAuthToken) {
                             signInWithCustomToken(auth, internalAuthToken).catch(err => console.error("Token Auth Fail", err));
                         } else {
                             signInAnonymously(auth).catch(err => console.error("Anon Auth Fail", err));
                         }
                    }
                });
                return;
            }

            // 2. External Environment (GitHub Pages)
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('current-user-id').textContent = userId;
                        document.getElementById('auth-status').textContent = `Authenticated (External) User: ${userId}`;
                        setupRealtimeListeners();
                        initializeItinerary();
                    } else {
                        // External: Always anonymous
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Firebase Auth failed:", error);
                            document.getElementById('auth-status').textContent = `Authentication failed. ${error.message}`;
                        }
                    }
                });
            } else {
                // 3. Missing Config
                console.error("Firebase config is missing or incomplete. Data persistence will not work.");
                document.getElementById('auth-status').textContent = "‚ö†Ô∏è OFFLINE MODE: Please update Firebase config in index.html.";
            }
        }
        
        // --- EVENT LISTENERS ---

        window.onload = function() {
            renderItineraryStructure();
            initializeFirebase();
            
            // Set up chat form listener
            document.getElementById('chat-form').addEventListener('submit', sendChatMessage);
        };
        
    </script>

</body>
</html>
