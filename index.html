<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orlando Family Trip Planner</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- OPTIONAL: Load external config if it exists (for GitHub) -->
    <!-- This allows you to save your keys in firebase-config.js and never edit this file again! -->
    <script src="firebase-config.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3e8; /* Light Cream Background */
        }
        .tab-button {
            transition: all 0.2s;
        }
        .tab-button.active {
            box-shadow: 0 4px #c2410c; /* Amber line for active tab */
            background-color: #fef3c7;
            color: #b91c1c; /* Red text */
            border-bottom: 2px solid #b91c1c;
        }
        .chat-container {
            max-height: 400px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .spreadsheet-cell {
            padding: 8px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .spreadsheet-cell:hover {
            background-color: #fef9e8;
        }
        [contenteditable="true"]:focus {
            outline: 2px solid #fb923c; /* Orange focus ring */
            background-color: white;
        }
    </style>
</head>
<body>

    <div class="max-w-7xl mx-auto p-4 md:p-8 bg-white shadow-xl rounded-xl mt-4 mb-8 border-t-8 border-red-700">

        <!-- HEADER & FAMILY INFO -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-red-700 mb-2 tracking-tight">
                Blair/Rosenberg Christmas Orlando 2025 üè∞
            </h1>
            <p class="text-xl text-gray-600">Real-time collaboration for the trip of a lifetime!</p>
            
            <!-- FAMILY PHOTO SECTION -->
            <div class="mt-6 flex justify-center">
                <img 
                    src="family_photo.png" 
                    alt="The Blair & Rosenberg Family" 
                    class="rounded-xl shadow-2xl max-w-full h-auto md:max-w-2xl border-4 border-white bg-gray-200"
                    onerror="this.style.display='none'"
                >
            </div>

            <div class="mt-4 p-2 bg-white inline-block rounded shadow-sm">
                <div id="auth-status" class="text-sm text-green-600 font-semibold">Initializing...</div>
                <div class="text-xs text-gray-400 mt-1">User ID: <span id="current-user-id">...</span></div>
            </div>
        </header>

        <!-- NAVIGATION TABS -->
        <div class="flex flex-wrap justify-center border-b border-gray-200 mb-6">
            <button onclick="showTab('dashboard')" class="tab-button active py-3 px-4 md:px-6 text-lg font-medium text-gray-600 hover:text-red-600 rounded-t-lg" data-tab="dashboard">Dashboard</button>
            <button onclick="showTab('itinerary')" class="tab-button py-3 px-4 md:px-6 text-lg font-medium text-gray-600 hover:text-red-600 rounded-t-lg" data-tab="itinerary">Itinerary & Budget</button>
            <button onclick="showTab('chat')" class="tab-button py-3 px-4 md:px-6 text-lg font-medium text-gray-600 hover:text-red-600 rounded-t-lg" data-tab="chat">Group Chat & Ideas</button>
            <button onclick="showTab('gpt')" class="tab-button py-3 px-4 md:px-6 text-lg font-medium text-gray-600 hover:text-red-600 rounded-t-lg" data-tab="gpt">Mickey's Planning Pal GPT</button>
        </div>

        <!-- TAB CONTENT -->

        <!-- 1. DASHBOARD TAB -->
        <div id="tab-dashboard" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Family/Disney Visuals & Links -->
                <div class="col-span-1 lg:col-span-2 space-y-6">
                    <div class="bg-yellow-50 p-6 rounded-xl shadow-md border-l-4 border-yellow-400">
                        <h2 class="text-2xl font-bold text-gray-800 mb-3 flex items-center">
                            Welcome Family! üë®‚Äçüë©‚Äçüëß‚Äçüë¶
                        </h2>
                        <div class="flex flex-wrap gap-4 items-start">
                            <div class="text-4xl space-x-2 pt-2">
                                üê≠ üè∞ üåü ‚ú® üöÄ üëë
                            </div>
                            <p class="text-gray-700 mt-2 text-sm">
                                This is our shared hub! We are 12 people (6 adults, 6 kids/young adults) traveling together. Let's make this the best Christmas ever!
                            </p>
                        </div>
                    </div>

                    <!-- Hotel Info -->
                    <div class="bg-blue-50 p-6 rounded-xl shadow-md border-l-4 border-blue-400">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-600" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707l-.707-.707V8a6 6 0 00-6-6zm-6 8.28V8a6 6 0 1112 0v2.28a1 1 0 00.27.67l.73.73H3l.73-.73a1 1 0 00.27-.67zM10 18a3 3 0 100-6 3 3 0 000 6z"/></svg>
                            Our Home Base: Waldorf Astoria Orlando
                        </h3>
                        <ul class="text-sm space-y-2 text-gray-700 list-disc list-inside">
                            <li>**Official Disney Hotel:** Offers complimentary luxury coach transportation to all Disney parks and Disney Springs.</li>
                            <li>**Amenities:** Access to two pools, luxe private cabanas, a zero-entry pool (great for Riley, 1), and use of the lazy river/water slide at the adjacent Signia by Hilton Bonnet Creek.</li>
                            <li>**Kids Club:** WA Kids Club (ages 5-12, perfect for Billie, 10, Mimi, 6, Joey, 5, and Emma, 7) offers supervised evening activities.</li>
                            <li>**Dining:** Multiple options including Oscar's Brasserie (great breakfast buffet), Bull & Bear Steakhouse, and poolside Aquamarine.</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Flight Info & Links Column -->
                <div class="col-span-1 space-y-6">
                    <div class="bg-green-50 p-6 rounded-xl shadow-md border-l-4 border-green-400">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                            ‚úàÔ∏è Flights Status
                        </h3>
                        <div id="flights-info" class="space-y-3 text-sm">
                            <div class="flex justify-between items-center p-2 bg-white rounded-lg shadow-sm">
                                <span class="font-semibold text-gray-700">Marc & Melissa's Crew:</span>
                                <span class="text-green-600 font-bold">Confirmed - Dec 21st</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white rounded-lg shadow-sm">
                                <span class="font-semibold text-gray-700">Daniel & Jessica's Crew:</span>
                                <span class="text-red-600 font-bold">TBD - Need to Book!</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white rounded-lg shadow-sm">
                                <span class="font-semibold text-gray-700">John, Lindsay & Ricky:</span>
                                <span class="text-green-600 font-bold">Confirmed - Dec 20th</span>
                            </div>
                        </div>
                    </div>

                    <!-- External Links -->
                    <div class="bg-gray-50 p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                            üîó Key Links
                        </h3>
                        <ul class="space-y-2 text-sm">
                            <li><a href="https://disneyworld.disney.go.com/" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium">Official Walt Disney World Site</a></li>
                            <li><a href="https://waldorfastoriaorlando.com/" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium">Waldorf Astoria Orlando</a></li>
                            <li><a href="https://disneyworld.disney.go.com/events-tours/holidays/" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium">Disney Christmas Events Info</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. ITINERARY & SPREADSHEET TAB -->
        <div id="tab-itinerary" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-red-700 mb-4">Collaborative Trip Itinerary & Budget</h2>
            <p class="text-sm text-gray-600 mb-4">Edit any cell directly! All changes are saved instantly and shared with the group.</p>
            
            <div class="overflow-x-auto rounded-lg shadow-lg">
                <table class="min-w-full bg-white border-collapse">
                    <thead>
                        <tr class="bg-red-600 text-white text-sm uppercase tracking-wider">
                            <th class="p-3 border-r border-red-700 sticky left-0 bg-red-600 w-32">Date / Time</th>
                            <th class="p-3 border-r border-red-700 w-48">Activity</th>
                            <th class="p-3 border-r border-red-700 w-24">Cost</th>
                            <th class="p-3 border-r border-red-700 w-24">Status</th>
                            <!-- Family Members Columns -->
                            <th class="p-3 border-r border-red-700 text-center">Marc (43)</th>
                            <th class="p-3 border-r border-red-700 text-center">Mel (39)</th>
                            <th class="p-3 border-r border-red-700 text-center">Billie (10)</th>
                            <th class="p-3 border-r border-red-700 text-center">Mimi (6)</th>
                            <th class="p-3 border-r border-red-700 text-center">Dan (39)</th>
                            <th class="p-3 border-r border-red-700 text-center">Jess (37)</th>
                            <th class="p-3 border-r border-red-700 text-center">Joey (5)</th>
                            <th class="p-3 border-r border-red-700 text-center">Emma (7)</th>
                            <th class="p-3 border-r border-red-700 text-center">Riley (1)</th>
                            <th class="p-3 border-r border-red-700 text-center">John (71)</th>
                            <th class="p-3 border-r border-red-700 text-center">Lin (70)</th>
                            <th class="p-3 text-center">Ricky (41)</th>
                        </tr>
                    </thead>
                    <tbody id="itinerary-table-body" class="text-gray-700">
                        <!-- Itinerary Rows will be dynamically added here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <button onclick="addItineraryRow()" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                Add New Item
            </button>
        </div>

        <!-- 3. GROUP CHAT & SUGGESTIONS TAB -->
        <div id="tab-chat" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-red-700 mb-4">Group Suggestion Box & Chat</h2>
            
            <div class="bg-gray-100 p-4 rounded-xl shadow-inner mb-4 chat-container" id="chat-messages">
                <p class="text-center text-gray-500">Loading real-time suggestions...</p>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-lg border">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Send a Message or Suggestion</h3>
                <textarea id="chat-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" rows="3" placeholder="Type your idea or question here..."></textarea>
                <button onclick="sendMessage()" class="mt-3 w-full md:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150 shadow-md">
                    Submit Suggestion
                </button>
            </div>
        </div>

        <!-- 4. CUSTOM GPT PLANNER TAB -->
        <div id="tab-gpt" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-red-700 mb-4">Mickey's Planning Pal üß†</h2>
            <p class="text-base text-gray-600 mb-4">Ask our custom AI planner for ideas, tips, or facts about our Orlando Christmas trip. The Pal is a Disney expert!</p>
            
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Chat Window -->
                <div class="lg:w-2/3 bg-white p-5 rounded-xl shadow-lg border">
                    <div id="gpt-chat-log" class="chat-container bg-gray-50 p-4 rounded-lg mb-4 h-96">
                        <div class="text-center text-gray-500 py-4">
                            <p class="font-bold text-red-600">Mickey's Planning Pal</p>
                            <p>Hello! I'm here to help you plan the most magical family Christmas in Orlando. Ask me anything!</p>
                        </div>
                    </div>
                    
                    <!-- Input -->
                    <div class="flex space-x-3">
                        <input type="text" id="gpt-input" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="Ask a question about the trip...">
                        <button id="gpt-send-button" onclick="sendGptQuery()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md disabled:opacity-50">
                            Ask Pal
                        </button>
                    </div>
                </div>

                <!-- Info Box -->
                <div class="lg:w-1/3 bg-yellow-100 p-5 rounded-xl shadow-md border border-yellow-300">
                    <h3 class="text-xl font-bold text-yellow-800 mb-3">Grounding Sources</h3>
                    <div id="gpt-sources" class="text-sm text-yellow-700 space-y-2">
                        <p>Sources for the Pal's advice will appear here.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL CONFIGURATION ---
        
        // 1. INTERNAL PREVIEW CONFIG (Available inside this editor)
        const internalConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const internalAppId = typeof __app_id !== 'undefined' ? __app_id : null;
        const internalAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 2. EXTERNAL DEPLOYMENT CONFIG (For GitHub Pages)
        // We try to read from a separate file (window.GIT_FIREBASE_CONFIG).
        let externalConfig = {
            apiKey: "YOUR_API_KEY_HERE", 
            authDomain: "YOUR_AUTH_DOMAIN_HERE", 
            projectId: "YOUR_PROJECT_ID_HERE", 
            storageBucket: "YOUR_STORAGE_BUCKET_HERE", 
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID_HERE", 
            appId: "YOUR_APP_ID_HERE"
        };

        if (window.GIT_FIREBASE_CONFIG) {
            console.log("Loaded external config from firebase-config.js");
            externalConfig = window.GIT_FIREBASE_CONFIG;
        }

        // LOGIC: Prefer Internal Config (for immediate preview), fall back to External
        let firebaseConfig;
        let appId;
        let isInternalEnv = false;

        if (internalConfig) {
            // We are in the preview environment
            firebaseConfig = internalConfig;
            appId = internalAppId || 'default-app-id';
            isInternalEnv = true;
        } else {
            // We are on GitHub Pages (or local file)
            firebaseConfig = externalConfig;
            appId = "orlando-trip-app-prod"; 
            isInternalEnv = false;
        }

        let app;
        let db;
        let auth;
        let userId = 'loading';
        
        // The list of family members for the spreadsheet columns
        const FAMILY_MEMBERS = [
            { id: "Marc", name: "Marc Blair", age: 43 },
            { id: "Melissa", name: "Melissa Blair", age: 39 },
            { id: "Billie", name: "Billie Blair", age: 10 },
            { id: "Mimi", name: "Mimi Blair", age: 6 },
            { id: "Daniel", name: "Daniel Rosenberg", age: 39 },
            { id: "Jessica", name: "Jessica Blair", age: 37 },
            { id: "Joey", name: "Joey Rosenberg", age: 5 }, 
            { id: "Emma", name: "Emma Rosenberg", age: 7 }, 
            { id: "Riley", name: "Riley Rosenberg", age: 1 },
            { id: "John", name: "John Blair", age: 71 },
            { id: "Lindsay", name: "Lindsay Blair", age: 70 },
            { id: "Ricky", name: "Ricky Blair", age: 41 },
        ];

        const ITINERARY_DOC_PATH = `artifacts/${appId}/public/data/orlando_planning/itinerary`;
        const CHAT_COLLECTION_PATH = `artifacts/${appId}/public/data/orlando_planning_chat`;

        // --- UI UTILITIES ---

        window.showTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
        }

        // --- AUTHENTICATION & INITIALIZATION ---

        function initializeFirebase() {
            // Logic to verify if we have a valid configuration
            // 1. Internal Environment
            if (isInternalEnv) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('current-user-id').textContent = userId;
                        document.getElementById('auth-status').textContent = `Online (Internal)`;
                        setupRealtimeListeners();
                        initializeItinerary();
                    } else {
                         if (internalAuthToken) {
                             signInWithCustomToken(auth, internalAuthToken).catch(err => console.error("Token Auth Fail", err));
                         } else {
                             signInAnonymously(auth).catch(err => console.error("Anon Auth Fail", err));
                         }
                    }
                });
                return;
            }

            // 2. External Environment (GitHub Pages)
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('current-user-id').textContent = userId;
                        document.getElementById('auth-status').textContent = `Online (External)`;
                        setupRealtimeListeners();
                        initializeItinerary();
                    } else {
                        // External: Always anonymous
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Firebase Auth failed:", error);
                            document.getElementById('auth-status').textContent = `Authentication failed. ${error.message}`;
                        }
                    }
                });
            } else {
                // 3. Missing Config
                console.error("Firebase config is missing or incomplete.");
                document.getElementById('auth-status').textContent = "‚ö†Ô∏è OFFLINE: Config missing. Create firebase-config.js!";
                document.getElementById('auth-status').className = "text-sm text-red-600 font-bold";
            }
        }

        // --- FIRESTORE LISTENERS & LOGIC ---

        function setupRealtimeListeners() {
            if (!db) return;

            // 1. Itinerary Listener
            onSnapshot(doc(db, ITINERARY_DOC_PATH), (docSnap) => {
                const data = docSnap.data();
                if (data && data.items) {
                    renderItinerary(data.items);
                }
            });

            // 2. Chat Listener
            const q = query(collection(db, CHAT_COLLECTION_PATH), orderBy("timestamp", "asc"));
            onSnapshot(q, (snapshot) => {
                renderChat(snapshot.docs.map(d => d.data()));
            });
        }
        
        // ... (Rest of itinerary/chat/GPT logic remains similar to previous versions) ...

        // --- ITINERARY RENDER LOGIC ---
        
        window.currentItineraryItems = [];

        async function initializeItinerary() {
            if (!db) return;
            const docRef = doc(db, ITINERARY_DOC_PATH);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists() || !docSnap.data().items || docSnap.data().items.length === 0) {
                const initialItinerary = [
                    createItineraryItem("Dec 22", "Arrivals / Check-in", 0, "Booked", "Marc, Melissa"),
                    createItineraryItem("Dec 23", "Epcot Holiday Festival", 300, "Planned", "All"),
                ];
                await setDoc(docRef, { items: initialItinerary });
            }
        }

        function createItineraryItem(date, activity, cost, status, attendeesText) {
            const attendees = {};
            // Default everyone to N unless specified 'All'
            const isAll = attendeesText.toLowerCase().includes('all') || attendeesText.toLowerCase().includes('everyone');
            
            FAMILY_MEMBERS.forEach(member => {
                if (isAll) {
                    attendees[member.id] = 'Y';
                } else {
                    attendees[member.id] = attendeesText.includes(member.id) ? 'Y' : 'N';
                }
            });

            return {
                id: crypto.randomUUID(),
                date: date,
                activity: activity,
                cost: cost,
                status: status,
                attendees: attendees,
            };
        }

        function renderItinerary(items) {
            const tableBody = document.getElementById('itinerary-table-body');
            tableBody.innerHTML = '';
            window.currentItineraryItems = items;

            items.forEach((item) => {
                const row = tableBody.insertRow();
                row.className = 'border-t hover:bg-red-50 transition duration-100';

                // Core fields
                ['date', 'activity', 'cost', 'status'].forEach((field, colIndex) => {
                    const cell = row.insertCell();
                    cell.className = `spreadsheet-cell ${colIndex === 0 ? 'sticky left-0 bg-white shadow-sm font-semibold' : ''} text-sm whitespace-nowrap`;
                    cell.setAttribute('contenteditable', 'true');
                    cell.dataset.id = item.id;
                    cell.dataset.field = field;
                    cell.textContent = item[field] || '';
                    cell.addEventListener('blur', handleCellEdit);
                });

                // Attendee fields
                FAMILY_MEMBERS.forEach(member => {
                    const cell = row.insertCell();
                    cell.className = 'spreadsheet-cell text-center text-sm font-mono cursor-pointer';
                    cell.dataset.id = item.id;
                    cell.dataset.field = `attendees.${member.id}`;
                    cell.textContent = item.attendees[member.id] || 'N';
                    
                    if(item.attendees[member.id] === 'Y') {
                        cell.classList.add('bg-green-100', 'text-green-700', 'font-bold');
                    } else {
                        cell.classList.add('text-gray-300');
                    }
                    
                    cell.addEventListener('click', handleAttendeeToggle);
                });
            });
        }

        window.addItineraryRow = async function() {
            if (!db) return;
            const newItem = createItineraryItem('Date?', 'New Activity...', 0, 'Idea', '');
            const newItems = [...(window.currentItineraryItems || []), newItem];
            await setDoc(doc(db, ITINERARY_DOC_PATH), { items: newItems });
        }
        
        async function handleCellEdit(event) {
            if (!db) return;
            const target = event.target;
            const id = target.dataset.id;
            const field = target.dataset.field;
            const value = target.textContent.trim();
            
            const updatedItems = window.currentItineraryItems.map(item => {
                if (item.id === id) {
                    return { ...item, [field]: field === 'cost' ? parseFloat(value) || 0 : value };
                }
                return item;
            });
            await setDoc(doc(db, ITINERARY_DOC_PATH), { items: updatedItems });
        }

        async function handleAttendeeToggle(event) {
            if (!db) return;
            const target = event.target;
            const id = target.dataset.id;
            const field = target.dataset.field; 
            if (!id || !field) return;

            const memberId = field.split('.')[1];
            const currentValue = target.textContent === 'Y' ? 'N' : 'Y';

            const updatedItems = window.currentItineraryItems.map(item => {
                if (item.id === id) {
                    return { 
                        ...item, 
                        attendees: { ...item.attendees, [memberId]: currentValue } 
                    };
                }
                return item;
            });
            await setDoc(doc(db, ITINERARY_DOC_PATH), { items: updatedItems });
        }

        // --- CHAT RENDER LOGIC ---

        function renderChat(messages) {
            const chatLog = document.getElementById('chat-messages');
            chatLog.innerHTML = '';
            if (messages.length === 0) chatLog.innerHTML = '<p class="text-center text-gray-500 py-4">No suggestions yet!</p>';

            messages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = 'mb-3 p-3 rounded-lg shadow-sm';
                const isMine = msg.userId === userId;

                if (isMine) {
                    messageElement.classList.add('bg-red-100', 'ml-auto', 'max-w-[90%]');
                } else {
                    messageElement.classList.add('bg-white', 'mr-auto', 'max-w-[90%]');
                }

                const date = msg.timestamp ? new Date(msg.timestamp.toMillis()) : new Date();
                const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageElement.innerHTML = `
                    <p class="text-xs ${isMine ? 'text-red-700' : 'text-gray-500'} font-semibold mb-1">
                        ${msg.userName} <span class="float-right font-normal text-gray-400">${timeString}</span>
                    </p>
                    <p class="text-gray-800 whitespace-pre-wrap">${msg.text}</p>
                `;
                chatLog.appendChild(messageElement);
            });
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        window.sendMessage = async function() {
            if (!db) return;
            const chatInput = document.getElementById('chat-input');
            const val = chatInput.value.trim();
            if (!val) return;

            const user = auth.currentUser;
            const userName = user && user.isAnonymous ? 'Guest Planner' : 'Family Member';

            await addDoc(collection(db, CHAT_COLLECTION_PATH), {
                userId: userId,
                userName: userName,
                text: val,
                timestamp: serverTimestamp(),
            });
            chatInput.value = '';
        }

        // --- GPT LOGIC ---
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key="; 
        
        window.sendGptQuery = async function() {
            const inputElement = document.getElementById('gpt-input');
            const chatLog = document.getElementById('gpt-chat-log');
            const userQuery = inputElement.value.trim();
            if (!userQuery) return;

            // User Msg
            const msgDiv = document.createElement('div');
            msgDiv.className = "p-3 rounded-lg shadow-sm mb-3 bg-red-100 ml-auto max-w-[90%]";
            msgDiv.innerHTML = `<p class="text-xs text-red-700 font-semibold">You</p><p>${userQuery}</p>`;
            chatLog.appendChild(msgDiv);
            inputElement.value = '';

            // Fake "Thinking"
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = "Thinking... üß†";
            loadingDiv.className = "text-sm text-gray-500 p-2";
            chatLog.appendChild(loadingDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
            
            setTimeout(() => {
                loadingDiv.remove();
                const responseDiv = document.createElement('div');
                responseDiv.className = "p-3 rounded-lg shadow-sm mb-3 bg-white mr-auto max-w-[90%] border border-gray-200";
                responseDiv.innerHTML = `<p class="text-xs text-blue-600 font-semibold">Mickey's Pal</p><p>That's a great question about "${userQuery}"! Since I am a static demo, I can't browse the live web right now, but remember to check the My Disney Experience app for the latest wait times!</p>`;
                chatLog.appendChild(responseDiv);
                chatLog.scrollTop = chatLog.scrollHeight;
            }, 1500);
        }

        // --- BOOTSTRAP ---
        window.onload = initializeFirebase;

    </script>
</body>
</html>
